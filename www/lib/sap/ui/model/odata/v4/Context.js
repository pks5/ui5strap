/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2016 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/model/Context","sap/ui/model/odata/v4/_ODataHelper","./lib/_Helper","./lib/_SyncPromise"],function(B,_,a,b){"use strict";function c(o){return o&&JSON.parse(JSON.stringify(o));}function f(o,p,e){var E,P=[o.fetchValue(p)],r=o.getPath(p);if(e){P.push(o.oModel.getMetaModel().fetchUI5Type(r));}return b.all(P).then(function(R){var t=R[1],v=R[0];if(v&&typeof v==="object"){E=new Error("Accessed value is not primitive: "+r);E.isNotPrimitive=true;throw E;}return e?t.formatValue(v,"string"):v;});}var C=B.extend("sap.ui.model.odata.v4.Context",{constructor:function(m,o,p,i){B.call(this,m,p);this.oBinding=o;this.iIndex=i;}});C.prototype.deregisterBinding=function(d){_.deregisterBinding(this.oBinding,d);};C.prototype.deregisterChange=function(p,l){this.oBinding.deregisterChange(p,l,this.iIndex);};C.prototype.fetchAbsoluteValue=function(p){return this.oBinding.fetchAbsoluteValue(p);};C.prototype.fetchCanonicalPath=function(){return this.oModel.getMetaModel().fetchCanonicalPath(this);};C.prototype.fetchValue=function(p,l){return this.oBinding.fetchValue(p,l,this.iIndex);};C.prototype.getBinding=function(){return this.oBinding;};C.prototype.getCanonicalPath=b.createGetMethod("fetchCanonicalPath",true);C.prototype.getIndex=function(){return this.iIndex;};C.prototype.getQueryOptions=function(p){return _.getQueryOptions(this.oBinding,p);};C.prototype.getObject=function(p){var s=this.fetchValue(p);if(!s.isFulfilled()){return undefined;}return c(s.getResult());};C.prototype.getProperty=function(p,e){var E,s=f(this,p,e);if(s.isRejected()){E=s.getResult();if(E.isNotPrimitive){throw E;}}return s.isFulfilled()?s.getResult():undefined;};C.prototype.hasPendingChanges=function(p){return _.hasPendingChanges(this.oBinding,undefined,a.buildPath(this.iIndex,p));};C.prototype.registerBinding=function(d){_.registerBinding(this.oBinding,d);};C.prototype.requestCanonicalPath=b.createRequestMethod("fetchCanonicalPath");C.prototype.requestObject=function(p){return Promise.resolve(this.fetchValue(p)).then(function(r){return c(r);});};C.prototype.requestProperty=function(p,e){return Promise.resolve(f(this,p,e));};C.prototype.resetChanges=function(p){return _.resetChanges(this.oBinding,undefined,a.buildPath(this.iIndex,p));};C.prototype.updateValue=function(g,p,v,e,P){var t=this;P=a.buildPath(this.iIndex,P);if(e){return this.oBinding.updateValue(g,p,v,e,P);}return this.requestCanonicalPath().then(function(e){return t.oBinding.updateValue(g,p,v,e.slice(1),P);});};C.prototype.toString=function(){return this.iIndex===undefined?this.sPath:this.sPath+"["+this.iIndex+"]";};return{create:function(m,o,p,i){if(p[0]!=="/"){throw new Error("Not an absolute path: "+p);}if(p.slice(-1)==="/"){throw new Error("Unsupported trailing slash: "+p);}return new C(m,o,p,i);}};},false);
