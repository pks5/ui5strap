/*!
 * SAP UI development toolkit for HTML5 (SAPUI5/OpenUI5)
 * (c) Copyright 2009-2014 SAP AG or an SAP affiliate company. 
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['jquery.sap.global','sap/ui/core/Control','./ExportColumn','./ExportRow','./ExportType','./File'],function(q,C,E,a,b,F){'use strict';var c=C.extend('sap.ui.core.util.Export',{metadata:{publicMethods:["generate","saveFile"],library:"sap.ui.core",aggregations:{exportType:{type:'sap.ui.core.util.ExportType',multiple:false},columns:{type:'sap.ui.core.util.ExportColumn',multiple:true,bindable:'bindable'},rows:{type:'sap.ui.core.util.ExportRow',multiple:true,bindable:'bindable'},_template:{type:'sap.ui.core.util.ExportRow',multiple:false,visibility:'hidden'}}}});c.getMetadata().getAllAggregations()["rows"]._doesNotRequireFactory=true;c.prototype.init=function(){this._oDeferred=null;this._oRowBindingInfo=null};c.prototype.exit=function(){delete this._oDeferred;delete this._oRowBindingInfo};c.prototype._createRowTemplate=function(){var t=new a(this.getId()+"-row"),d=this.getColumns();for(var i=0,l=d.length;i<l;i++){var o=d[i].getTemplate();if(o){t.addCell(o.clone("col"+i))}}return t};c.prototype.bindAggregation=function(n,B){if(n==='rows'){this._oRowBindingInfo=B;return this}return C.prototype.bindAggregation.apply(this,arguments)};c.prototype.updateRows=function(r){if(r==='change'){var s=this.getExportType()._generate(this);this.destroyAggregation('_template');this.unbindAggregation('rows');this._oDeferred.resolveWith(this,[s]);this._oDeferred=null}};c.prototype.generate=function(){if(!this._oDeferred){this._oDeferred=q.Deferred();var p=this._oDeferred.promise();if(!this.hasModel()){this._oDeferred.rejectWith(this,["Generate is not possible beause no model was set."])}else{var t=this._createRowTemplate();this.setAggregation('_template',t,true);C.prototype.bindAggregation.call(this,'rows',this._oRowBindingInfo);if(this.getBinding("rows")){this.getBinding("rows").getContexts(0,this.getBinding("rows").getLength())}}return p}return this._oDeferred.promise()};c.prototype.saveFile=function(f){return this.generate().then(function(s){var e=this.getExportType();F.save(s,f||"data",e.getFileExtension(),e.getMimeType(),e.getCharset())})};return c},true);
