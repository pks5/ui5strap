/*!
 * SAP UI development toolkit for HTML5 (SAPUI5/OpenUI5)
 * (c) Copyright 2009-2014 SAP AG or an SAP affiliate company. 
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['jquery.sap.global','sap/ui/model/TreeBinding','./AnalyticalBinding'],function(q,T,A){"use strict";var a=function(){if(!(this instanceof T&&this.getContexts===undefined)){return}for(var f in a.prototype){if(a.prototype.hasOwnProperty(f)){this[f]=a.prototype[f]}}this._aContexts=[];this._aContextInfos=[];this._aExpanding=[];this._bInitial=true;this._oExpanded={};this._oOpenGroups={};this._bTriggeredOpenGroupsLoad=false};a.prototype._updateContexts=function(p,c,C,r){var I=p;for(var i=0;i<c.length;i++){var o=c[i];var b=C[i];this._aContexts.splice(p,r?1:0,o);this._aContextInfos.splice(p,r?1:0,b);p++}if(!r){this._fireContextChange({type:"insert",index:I,length:c.length})}return C};a.prototype.getLength=function(){return this._aContexts.length};a.prototype.getContextInfo=function(i){return this._aContextInfos.slice(i,i+1)[0]};a.prototype._createContextInfos=function(c,p,P,l,s,I){if(!I){I=0}var C=[];for(var i=0;i<c.length;i++){var o=c[i];C.push({context:o,level:l,expanded:false,childCount:0,parent:p,sum:s,position:P,index:i+I});P++}return C};a.prototype.getContexts=function(s,l,t){var b=this;if(!l){l=this.oModel.iSizeLimit}if(this._bInitial){var r=this.getRootContexts({startIndex:s,length:l,threshold:t,numberOfExpandedLevels:this.mParameters.numberOfExpandedLevels});if(r&&r.length>0){this._bInitial=false;var n=this._createContextInfos(r,null,0,0,true);if(this.bProvideGrandTotals){this._updateContexts(0,r,n)}this._aExpanding=n}}if(this._oOpenGroups!={}&&this._bTriggeredOpenGroupsLoad==false){this.loadGroups(this._oOpenGroups);this._bTriggeredOpenGroupsLoad=true}else{this._processExpand(l,t)}var c=this._aContexts.slice(s,s+l);var m={};q.each(c,function(i,C){if(!C){var o=b._aContextInfos[s+i];var p=o.parent;var S=m[p.getPath()];if(S){S.startIndex=Math.min(S.startIndex,o.index);S.position=Math.min(S.position,o.position);S.endIndex=Math.max(S.endIndex,o.index)}else{m[p.getPath()]={startIndex:o.index,endIndex:o.index,parent:o.parent,level:o.level-1,position:o.position}}}});var b=this,u=false;q.each(m,function(i,S){var M=b.getNodeContexts(S.parent,{startIndex:S.startIndex,length:S.endIndex-S.startIndex+1,threshold:t,level:S.level,numberOfExpandedLevels:Math.max(b.mParameters.numberOfExpandedLevels-S.level,0)});if(M.length>0){b._updateContexts(S.position,M,b._createContextInfos(M,S.parent,S.position,S.level+1,false),true);b._updateExpandedInfo(S.parent,S.level,S.startIndex,S.endIndex-S.startIndex+1,t);u=true}});if(u){c=this._aContexts.slice(s,s+l)}return c};a.prototype._processExpand=function(l,t){var b=this,s=this._aExpanding.length,c=false,h=this.hasMeasures();for(var i=this._aExpanding.length-1;i>=0;i--){var C=this._aExpanding[i];var o=C.context;var n=!this.bProvideGrandTotals&&o.getPath()==="/artificialRootContent";if(q.inArray(o,this._aContexts)==-1&&!n){continue}var d=this.getNodeContexts(o,{startIndex:0,length:l,threshold:t,level:C.level});if(d&&d.length>0){var r=this.getGroupSize(o,C.level),I=C.parent?C.position+1:0,p=I,L=C.level+1,e=this._createContextInfos(d,o,p,L,false);var c=false;for(var j=0;j<d.length;j++){if(L<this.aAggregationLevel.length&&this._oOpenGroups[this._getGroupIdFromContext(d[j],L)]){this._aExpanding.push(e[j]);delete this._oOpenGroups[this._getGroupIdFromContext(d[j],L)];c=true}}p+=e.length;var f=e.length;if(r>-1){for(var j=d.length;j<r;j++){d.push(undefined);e.push(this._createContextInfos([undefined],o,p,L,false,f)[0]);p++;f++}}if(o&&C.parent!=null&&r>1&&!this.mParameters.sumOnTop&&h){d.push(o);e.push(this._createContextInfos([o],o,p,L-1,true,f)[0])}var g=d.length;this._updateContexts(I,d,e);var k=I+g;var P;L--;var m=I;while(P=this._aContextInfos[m]){if(P.level==L){P.childCount=P.childCount+g;L--}m--;if(L<0)break}var u=this._aContextInfos[k];if(u){var v=this._aContextInfos[k-1].position-u.position+1;for(var j=k;j<this._aContextInfos.length;j++){this._aContextInfos[j].position+=v}}if(C){C.expanded=true}this._updateExpandedInfo(C.context,C.level,0,l,t);this._aExpanding.splice(i,1)}}if((s!=this._aExpanding.length&&this._aExpanding.length>0)||c){this._processExpand(l,t)}};a.prototype._updateExpandedInfo=function(c,l,s,L,t){var b=this._getGroupIdFromContext(c,l);var p=b.substr(0,b.length-1).split("/");var e=this._oExpanded;for(var j=0;j<p.length;j++){var P=p[j];if(j==0){P="root"}e[P]=e[P]||{};e=e[P];if(j==p.length-1){e["sections"]=e["sections"]||[];if(e["sections"].length==0){e["sections"].push({startIndex:s,length:L,threshold:t})}var E=false;for(var k=0;k<e["sections"].length;k++){var S=e["sections"][k];var i=S.startIndex+S.length+S.threshold;var d=s+L+t;if(S.startIndex<=s&&i>=d){return}else if(S.startIndex<=s&&i>=s){S.threshold=Math.max(S.threshold,t);S.length=d-S.startIndex-S.threshold;E=true}else if(S.startIndex>s&&i>d){S.length=S.length+(S.startIndex-s);S.startIndex=s;S.threshold=Math.max(S.threshold,t);E=true}else if(S.startIndex>s&&S.endIndex<d){S.startIndex=s;S.length=L;S.threshold=t;E=true}}if(!E){e["sections"].push({startIndex:s,length:L,threshold:t})}}else{e["children"]=e["children"]||{};e["childProperty"]=this.aAggregationLevel[j];e=e["children"]}}};a.prototype.expand=function(i){var c=this._aContextInfos[i];if(c.expanded){return}this._aExpanding.push(c)};a.prototype.collapse=function(I){var c=this._aContextInfos[I];var C=this._aContexts[I];if(!c.expanded){return}var p=c.position+1,l=c.childCount,L=c.level;var e=this._oExpanded["root"];var s=this._getGroupIdFromContext(C,L);var P=s.substr(0,s.length-1).split("/");for(var i=1;i<L;i++){e=e["children"][P[i]]}delete e["children"][P[P.length-1]];var r=p;this._aContexts.splice(p,l);this._aContextInfos.splice(p,l);p--;var o;while(o=this._aContextInfos[p]){if(o.level==L){o.childCount=o.childCount-l;L--}p--;if(L<0)break}if(r<this._aContextInfos.length){var d=this._aContextInfos[r-1].position-this._aContextInfos[r].position+1;for(var j=r;j<this._aContextInfos.length;j++){this._aContextInfos[j].position+=d}this._fireContextChange({type:"remove",index:r,length:Math.abs(d)})}c.expanded=false};a.prototype.collapseAll=function(l){if(!l||l<1){l=1}for(var i=0,j=this._aContextInfos.length;i<j;i++){if(this._aContextInfos[i].level==l){this.collapse(i);j=this._aContextInfos.length}}};a.prototype.toggleIndex=function(i){if(!this._aContextInfos[i].expanded){this.expand(i)}else{this.collapse(i)}};a.prototype.indexHasChildren=function(i){var c=this._aContextInfos[i];if(!c.parent||c.sum){return false}else{return A.prototype.hasChildren.call(this,c.context,{level:c.level})}};a.prototype.resetData=function(c){var r=A.prototype.resetData.call(this,c);this._aContexts=[];this._aContextInfos=[];this._aExpanding=[];this._oOpenGroups={};this._removeGroups(this._oExpanded["root"],0,'');this._oExpanded={};this._bInitial=true;this._bTriggeredOpenGroupsLoad=false;return r};a.prototype.updateAnalyticalInfo=function(c){var r=A.prototype.updateAnalyticalInfo.call(this,c);this._aContexts=[];this._aContextInfos=[];this._aExpanding=[];this._oOpenGroups={};this._removeGroups(this._oExpanded["root"],0,'');this._oExpanded={};this._bInitial=true;this._bTriggeredOpenGroupsLoad=false;return r};a.prototype._removeGroups=function(g,l,p){if(!g){return}this._oOpenGroups[p+'/']=g.sections;if(!g.childProperty){return}if(g.childProperty!=this.aAggregationLevel[l]){delete g.children;delete g.childProperty}else{for(var c in g.children){this._removeGroups(g.children[c],l+1,p+'/'+c)}}};a.prototype.attachContextChange=function(f,l){this.attachEvent("contextChange",f,l)};a.prototype.detachContextChange=function(f,l){this.detachEvent("contextChange",f,l)};a.prototype._fireContextChange=function(m){this.fireEvent("contextChange",m)};return a},true);
