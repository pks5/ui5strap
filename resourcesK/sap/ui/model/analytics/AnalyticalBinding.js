/*!
 * SAP UI development toolkit for HTML5 (SAPUI5/OpenUI5)
 * (c) Copyright 2009-2014 SAP AG or an SAP affiliate company. 
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['jquery.sap.global','sap/ui/model/TreeBinding','sap/ui/model/ChangeReason','sap/ui/model/Sorter','sap/ui/model/FilterOperator','./odata4analytics'],function(q,T,C,S,F,o){"use strict";var A=T.extend("sap.ui.model.analytics.AnalyticalBinding",{constructor:function(m,p,c,s,f,P){T.call(this,m,p,c,f,P);this.sEntitySetName=(P&&P.entitySet)?P.entitySet:undefined;this.bArtificalRootContext=false;this.aGlobalFilter=f;this.aGlobalSorter=s;this.aMaxAggregationLevel=[];this.aAggregationLevel=[];this.oPendingRequests={};this.oPendingRequestHandle=[];this.oGroupedRequests={};this.bUseBatchRequests=(P&&P.useBatchRequests===true)?true:false;this.bProvideTotalSize=(P&&P.provideTotalResultSize===false)?false:true;this.bProvideGrandTotals=(P&&P.provideGrandTotals===false)?false:true;this.aRequestQueue=[];this.iTotalSize=-1;this.mKey={};this.mFinalLength={};this.mLength={};this.bNeedsUpdate=false;this.oAnalyticalQueryResult=this.oModel.getAnalyticalExtensions().findQueryResultByName(this._getEntitySet());this.aAnalyticalInfo=[];this.mAnalyticalInfoByProperty={};this.updateAnalyticalInfo(P==undefined?[]:P.analyticalInfo)}});A.prototype.getRootContexts=function(p){var a=(p&&p.numberOfExpandedLevels?p.numberOfExpandedLevels+1:1);var r=null;var R=this._getRequestId(A._requestType.groupMembersQuery,{groupId:null});if(this.bArtificalRootContext&&!this._cleanupGroupingForCompletedRequest(R)){return null}if(a<=1){r=this._getContextsForParentContext(null);if(a==1){this._considerRequestGrouping([R,this._getRequestId(A._requestType.groupMembersQuery,{groupId:"/"})]);this.getNodeContexts(this.getModel().getContext("/"),{startIndex:p.startIndex,length:p.length,threshold:p.threshold,level:0,numberOfExpandedLevels:0})}}else{r=this._getContextsForParentContext(null);var b=this._prepareGroupMembersAutoExpansionRequestIds("/",p.numberOfExpandedLevels);b.push(R);this._considerRequestGrouping(b);this.getNodeContexts(this.getModel().getContext("/"),{startIndex:p.startIndex,length:p.length,threshold:p.threshold,level:0,numberOfExpandedLevels:p.numberOfExpandedLevels})}if(r.length>1)q.sap.log.fatal("assertion failed: grand total represented by a single entry");return r};A.prototype.getNodeContexts=function(c,p){var s,l,t,L,n;if(typeof p=="object"){s=p.startIndex;l=p.length;t=p.threshold;L=p.level;n=p.numberOfExpandedLevels}else{s=arguments[1];l=arguments[2];t=arguments[3];L=arguments[4];n=arguments[5]}var a=this._getContextsForParentContext(c,s,l,t,L,n);return a};A.prototype.ContextsAvailabilityStatus={ALL:2,SOME:1,NONE:0};A.prototype.hasAvailableNodeContexts=function(c,l){var g=this._getGroupIdFromContext(c,l);if(this.mKey[g]!=undefined)if(this.mFinalLength[g]==true)return A.prototype.ContextsAvailabilityStatus.ALL;else return A.prototype.ContextsAvailabilityStatus.SOME;else return A.prototype.ContextsAvailabilityStatus.NONE};A.prototype.getGroupSize=function(c,l){if(c===undefined)return 0;var g=this._getGroupIdFromContext(c,l);return this.mFinalLength[g]?this.mLength[g]:-1};A.prototype.getTotalSize=function(){if(!this.bProvideTotalSize)q.sap.log.fatal("total size of result explicitly turned off, but getter invoked");return this.iTotalSize};A.prototype.hasChildren=function(c,p){if(c===undefined)return false;if(c==null)return true;var i=p.level;if(i==0)return true;if(this.aAggregationLevel.length<i)return false;return this.aMaxAggregationLevel.indexOf(this.aAggregationLevel[i-1])<this.aMaxAggregationLevel.length-1};A.prototype.hasMeasures=function(){var h=false;for(var p in this.oMeasureDetailsSet){h=true;break}return h};A.prototype.hasGrandTotalDisplayed=function(){return this.bProvideGrandTotals};A.prototype.getFilterablePropertyNames=function(){return this.oAnalyticalQueryResult.getEntityType().getFilterablePropertyNames()};A.prototype.getPropertyLabel=function(p){return this.oAnalyticalQueryResult.getEntityType().getLabelOfProperty(p)};A.prototype.filter=function(f){this.aPropertyFilter=f&&f.length>0?f:null;this.iTotalSize=-1;this._abortAllPendingRequests();this.resetData();this._fireRefresh({reason:C.Filter});return this};A.prototype.sort=function(s){if(s instanceof S){s=[s]}this.aPropertySorter=s;this._abortAllPendingRequests();this._fireRefresh({reason:C.Sort});return this};A.prototype.getGroupName=function(c,l){if(c===undefined)return"";var g=this.aAggregationLevel[l-1],d=this.oAnalyticalQueryResult.findDimensionByPropertyName(g),v=this.mAnalyticalInfoByProperty[g].formatter,p=c.getProperty(g),D=p==null?"":p,f=v?v(D):D,G=((d.getLabelText())?d.getLabelText()+': ':'')+f,t=null;if(d&&this.oDimensionDetailsSet[g].textPropertyName){t=d.getTextProperty()}if(t){var s=d.getTextProperty().name,a=this.mAnalyticalInfoByProperty[g].formatter,b=c.getProperty(s),e=b==null?"":b,h=a?a(e):e;if(h){G+=' - '+h}}return G};A.prototype.updateAnalyticalInfo=function(c){var p=this.oDimensionDetailsSet;this.mAnalyticalInfoByProperty=new Object();this.aMaxAggregationLevel=new Array();this.aAggregationLevel=new Array();this.aMeasureName=new Array();this.iAnalyticalInfoVersionNumber=(this.iAnalyticalInfoVersionNumber===undefined?1:(this.iAnalyticalInfoVersionNumber>999?1:this.iAnalyticalInfoVersionNumber+1));this.oMeasureDetailsSet=new Object();this.oDimensionDetailsSet=new Object();for(var i=0;i<c.length;i++){var d=this.oAnalyticalQueryResult.findDimensionByPropertyName(c[i].name);if(d&&(c[i].inResult==true||c[i].visible==true)){c[i].dimensionPropertyName=d.getName();var D=this.oDimensionDetailsSet[d.getName()];if(!D){D=new Object();D.name=d.getName();D.aAttributeName=new Array();D.grouped=false;this.oDimensionDetailsSet[d.getName()]=D;this.aMaxAggregationLevel.push(D.name);if(c[i].grouped==true)this.aAggregationLevel.push(D.name)}if(c[i].grouped==true)D.grouped=true;if(d.getName()==c[i].name){D.keyPropertyName=c[i].name}var t=d.getTextProperty();if(t&&t.name==c[i].name){D.textPropertyName=c[i].name}if(d.findAttributeByName(c[i].name)){D.aAttributeName.push(c[i].name)}}var m=this.oAnalyticalQueryResult.findMeasureByPropertyName(c[i].name);if(m&&(c[i].inResult==true||c[i].visible==true)){c[i].measurePropertyName=m.getName();var M=this.oMeasureDetailsSet[m.getName()];if(!M){M=new Object();M.name=m.getName();this.oMeasureDetailsSet[m.getName()]=M;this.aMeasureName.push(M.name)}if(m.getRawValueProperty().name==c[i].name){M.rawValuePropertyName=c[i].name}var f=m.getFormattedValueProperty();if(f&&f.name==c[i].name){M.formattedValuePropertyName=c[i].name}}this.mAnalyticalInfoByProperty[c[i].name]=c[i]}var M;for(var a in this.oMeasureDetailsSet){var u=this.oAnalyticalQueryResult.findMeasureByName(a).getUnitProperty();if(u)this.oMeasureDetailsSet[a].unitPropertyName=u.name}var b=function(e){var n=[];for(var g in e)n.push(g.name);return n.sort().join(";")};if(b(p)!=b(this.oDimensionDetailsSet))this.iTotalSize=-1;this.aAnalyticalInfo=c;this.mFinalLength={};this.mLength={};this.mKey={};this.mContexts={};this.bNeedsUpdate=false};A.prototype.getAnalyticalInfoForColumn=function(c){return this.mAnalyticalInfoByProperty[c]};A.prototype.loadGroups=function(g){var G=new Array();for(var s in g){G.push(s);delete this.mKey[s];delete this.mLength[s];delete this.mFinalLength[s];var a=g[s];for(var i=0;i<a.length;i++){var b=a[i];this._getContextsForParentGroupId(s,b.startIndex,b.length,b.threshold)}var r=new Array();for(var i=-1,s;s=G[++i];){r.push(this._getRequestId(A._requestType.groupMembersQuery,{groupId:s}))}this._considerRequestGrouping(r)}};A.prototype.getAnalyticalQueryResult=function(){return this.oAnalyticalQueryResult};A._requestType={groupMembersQuery:1,totalSizeQuery:2,groupMembersAutoExpansionQuery:3,levelMembersQuery:4,};A.prototype._getContextsForParentContext=function(p,s,l,t,L,n){if(p===undefined)return[];if(p&&p.getPath()=="/artificialRootContent"){p=this.getModel().getContext("/")}var P=this._getGroupIdFromContext(p,L);return this._getContextsForParentGroupId(P,s,l,t,n)};A.prototype._getContextsForParentGroupId=function(p,s,l,t,n){if(p===undefined)return[];if(!s)s=0;if(!l)l=this.oModel.iSizeLimit;if(this.mFinalLength[p]&&this.mLength[p]<l)l=this.mLength[p];if(!t)t=0;if(!n)n=0;var c,L,g,a,m;var G=n>0&&p!=null;if(G){a=[];m=l+t;L=true;c=[]}else{c=this._getLoadedContextsForGroup(p,s,l);g=this._calculateRequiredGroupSection(p,s,l,t,c);L=c.length!=l&&!(this.mFinalLength[p]&&c.length>=this.mLength[p]-s)}if(!L)this._cleanupGroupingForCompletedRequest(this._getRequestId(A._requestType.groupMembersQuery,{groupId:p}));if(this.oModel.getServiceMetadata()){if(L&&!this._isRequestPending(this._getRequestId(A._requestType.groupMembersQuery,{groupId:p}))){var N=this.bProvideTotalSize&&this.iTotalSize==-1&&!this._isRequestPending(this._getRequestId(A._requestType.totalSizeQuery));if(this.bUseBatchRequests){var M;if(G){this.aRequestQueue.push([A._requestType.groupMembersAutoExpansionQuery,p,a,m,n]);M=this._prepareGroupMembersAutoExpansionRequestIds()}else{this.aRequestQueue.push([A._requestType.groupMembersQuery,p,g.startIndex,g.length]);M=[this._getRequestId(A._requestType.groupMembersQuery,{groupId:p})]}if(N){M.push(this._getRequestId(A._requestType.totalSizeQuery));this._considerRequestGrouping(M);this.aRequestQueue.push([A._requestType.totalSizeQuery])}q.sap.delayedCall(0,this,A.prototype._processRequestQueue)}else{var b;var M;if(G){b=this._prepareGroupMembersAutoExpansionQueryRequest(A._requestType.groupMembersAutoExpansionQuery,p,a,m,n);M=b.aRequestId}else{b=this._prepareGroupMembersQueryRequest(A._requestType.groupMembersQuery,p,g.startIndex,g.length);M=[b.sRequestId]}this._executeQueryRequest(b);if(N&&!b.bIsFlatListRequest){M.push(this._getRequestId(A._requestType.totalSizeQuery));this._considerRequestGrouping(M);this._executeQueryRequest(this._prepareTotalSizeQueryRequest(A._requestType.totalSizeQuery))}}if(p==null)this._abortAllPendingRequests()}}return c};A.prototype._processRequestQueue=function(){if(this.aRequestQueue.length==0)return;var r=[];var f=false;for(var i=-1,R;R=this.aRequestQueue[++i];){if(R[0]==A._requestType.groupMembersQuery){var a=A.prototype._prepareGroupMembersQueryRequest.apply(this,R);f=f||a.bIsFlatListRequest;r.push(a)}}for(var i=-1,R;R=this.aRequestQueue[++i];){var a=null;switch(R[0]){case A._requestType.groupMembersQuery:continue;case A._requestType.totalSizeQuery:if(!f)a=A.prototype._prepareTotalSizeQueryRequest.apply(this,R);break;default:q.sap.log.fatal("unhandled request type "+this.aRequestQueue[i][0]);continue}if(a)r.push(a)}if(r.length>1)this._executeBatchRequest(r);else this._executeQueryRequest(r[0]);this.aRequestQueue=[]};A.prototype._prepareGroupMembersQueryRequest=function(r,g,s,L){var G=[];var c=this.iAnalyticalInfoVersionNumber;var a=new o.QueryResultRequest(this.oAnalyticalQueryResult);a.setResourcePath(this._getResourcePath());var b=0,d=-1;if(g){G=this._getGroupIdComponents(g);b=d=G.length;var u=0;for(var i=0,e=0;i<b;e++){if(this.oDimensionDetailsSet[this.aMaxAggregationLevel[e]].grouped==false)++u;else++i}b=d=b+u;if(this.aMaxAggregationLevel.length>0){while(this.oDimensionDetailsSet[this.aMaxAggregationLevel[d]].grouped==false)if(++d==this.aMaxAggregationLevel.length)break}}var f=this.aMaxAggregationLevel.slice(0,d+1);a.setAggregationLevel(f);for(var i=0;i<f.length;i++){var D=this.oDimensionDetailsSet[f[i]];var I=(D.keyPropertyName!=undefined);var h=true;a.includeDimensionKeyTextAttributes(D.name,true,h,D.aAttributeName)}var j=a.getFilterExpression();j.clear();if(this.aGlobalFilter)j.addUI5FilterConditions(this.aGlobalFilter);if(this.aPropertyFilter)j.addUI5FilterConditions(this.aPropertyFilter);if(b>=1){for(var i=0,l=G.length;i<l;i++){j.addCondition(this.aAggregationLevel[i],F.EQ,G[i])}}var k=!(this.aMaxAggregationLevel.length-d-1>0);var m;var n;var p;var M;var t=new Array();if(g!=null||this.bProvideGrandTotals){a.setMeasures(this.aMeasureName);for(var v in this.oMeasureDetailsSet){M=this.oMeasureDetailsSet[v];if(!k&&this.mAnalyticalInfoByProperty[v].total==false){m=false;n=false;p=false}else{m=(M.rawValuePropertyName!=undefined);n=(M.formattedValuePropertyName!=undefined);p=(M.unitPropertyName!=undefined);if(p){if(t.indexOf(M.unitPropertyName)==-1){t.push(M.unitPropertyName)}}}a.includeMeasureRawFormattedValueUnit(M.name,m,n,p)}for(var i in f){var w;if((w=t.indexOf(f[i]))!=-1)t.splice(w,1)}}var x=a.getSortExpression();x.clear();if(!k){for(var i in f){var y=o.SortOrder.Ascending;if(this.mAnalyticalInfoByProperty[f[i]].sorted)switch(this.mAnalyticalInfoByProperty[f[i]].sortOrder){case sap.ui.table.SortOrder.Ascending:y=o.SortOrder.Ascending;break;case sap.ui.table.SortOrder.Descending:y=o.SortOrder.Descending;break}x.addSorter(f[i],y)}}if(this.aGlobalSorter)this._applyUI5SorterToSortExpression(this.aGlobalSorter,x);if(this.aPropertySorter)this._applyUI5SorterToSortExpression(this.aPropertySorter,x);if(L==0)q.sap.log.fatal("unhandled case: load 0 entities of sub group");a.setResultPageBoundaries(s+1,s+L);a.setRequestOptions(null,!this.mFinalLength[g]);return{iRequestType:r,sRequestId:this._getRequestId(A._requestType.groupMembersQuery,{groupId:g}),oAnalyticalQueryRequest:a,sGroupId:g,aSelectedUnitPropertyName:t,aAggregationLevel:f,bIsFlatListRequest:k&&b==0,iStartIndex:s,iLength:L}};A.prototype._prepareTotalSizeQueryRequest=function(r){var c=this.iAnalyticalInfoVersionNumber;var a=new o.QueryResultRequest(this.oAnalyticalQueryResult);a.setResourcePath(this._getResourcePath());a.setAggregationLevel(this.aMaxAggregationLevel);a.setMeasures([]);var f=a.getFilterExpression();f.clear();if(this.aGlobalFilter)f.addUI5FilterConditions(this.aGlobalFilter);if(this.aPropertyFilter)f.addUI5FilterConditions(this.aPropertyFilter);a.setResultPageBoundaries(1,1);a.setRequestOptions(null,true);return{iRequestType:r,sRequestId:this._getRequestId(A._requestType.totalSizeQuery),oAnalyticalQueryRequest:a}};A.prototype._prepareGroupMembersAutoExpansionQueryRequest=function(r,g,a,l,n){var p=function(r,L,h,l){var j=[];var k=t.iAnalyticalInfoVersionNumber;var s=new o.QueryResultRequest(t.oAnalyticalQueryResult);s.setResourcePath(t._getResourcePath());var u=t.aAggregationLevel.slice(0,L);s.setAggregationLevel(u);for(var i=0;i<u.length;i++){var D=t.oDimensionDetailsSet[u[i]];var I=(D.keyPropertyName!=undefined);var v=(D.textPropertyName!=undefined);s.includeDimensionKeyTextAttributes(D.name,true,v,D.aAttributeName)}var w=s.getFilterExpression();w.clear();if(t.aGlobalFilter)w.addUI5FilterConditions(t.aGlobalFilter);if(t.aPropertyFilter)w.addUI5FilterConditions(t.aPropertyFilter);if(t.aPropertyFilter)w.addUI5FilterConditions(t.aPropertyFilter);w.addUI5FilterConditions(h);var x=0;var y=L-1==t.aAggregationLevel.length;var z;var B;var E;var M;var H=new Array();s.setMeasures(t.aMeasureName);for(var J in t.oMeasureDetailsSet){M=t.oMeasureDetailsSet[J];if(!y&&t.mAnalyticalInfoByProperty[J].total==false){z=false;B=false;E=false}else{z=(M.rawValuePropertyName!=undefined);B=(M.formattedValuePropertyName!=undefined);E=(M.unitPropertyName!=undefined);if(E){if(H.indexOf(M.unitPropertyName)==-1){H.push(M.unitPropertyName)}}}s.includeMeasureRawFormattedValueUnit(M.name,z,B,E)}for(var i in u){var K;if((K=H.indexOf(u[i]))!=-1)H.splice(K,1)}var N=s.getSortExpression();N.clear();if(!y){for(var i in u){var O=o.SortOrder.Ascending;if(t.mAnalyticalInfoByProperty[u[i]].sorted)switch(t.mAnalyticalInfoByProperty[u[i]].sortOrder){case sap.ui.table.SortOrder.Ascending:O=o.SortOrder.Ascending;break;case sap.ui.table.SortOrder.Descending:O=o.SortOrder.Descending;break}N.addSorter(u[i],O)}}if(t.aGlobalSorter)t._applyUI5SorterToSortExpression(t.aGlobalSorter,N);if(t.aPropertySorter)t._applyUI5SorterToSortExpression(t.aPropertySorter,N);if(l==0)q.sap.log.fatal("unhandled case: load 0 entities of sub group");s.setResultPageBoundaries(x+1,x+l);return{iRequestType:r,sRequestId:t._getRequestId(A._requestType.levelMembersQuery,{level:L}),oAnalyticalQueryRequest:s,iLevel:L,aSelectedUnitPropertyName:H,aAggregationLevel:u,bIsFlatListRequest:y,iStartIndex:x,iLength:l}};if(a.length!=0){q.sap.log.fatal("group header paths not supported yet");return}var m=this._getGroupIdLevel(g)+1;var b=m+n;var G=[];var R=[];var t=this;var f=[];var c=this._getGroupIdComponents(g);for(var i=0;i<c.length;i++)f.push(new sap.ui.model.Filter(this.aAggregationLevel[i],sap.ui.model.FilterOperator.EQ,c[i]));for(var L=m;L<=b;L++){var d=Math.ceil((l-L)/(b-L+1));var e=p(A._requestType.levelMembersQuery,L,f,d);G.push(e);R.push(this._getRequestId(A._requestType.levelMembersQuery,{level:L}))}return{iRequestType:r,aRequestId:R,aGroupMembersAutoExpansionRequestDetails:G,sGroupId:g,iLength:l}};A.prototype._prepareGroupMembersAutoExpansionRequestIds=function(g,n){var m=this._getGroupIdLevel(g)+1;var a=m+n;var r=[];for(var l=1;l<=a;l++){r.push(this._getRequestId(A._requestType.levelMembersQuery,{level:l}))}return r};A.prototype._getQueryODataRequestOptions=function(a){var s=a.getURIQueryOptionValue("$select");var f=a.getURIQueryOptionValue("$filter");var O=a.getURIQueryOptionValue("$orderby");var b=a.getURIQueryOptionValue("$skip");var t=a.getURIQueryOptionValue("$top");var i=a.getURIQueryOptionValue("$inlinecount");if(this.mParameters["filter"])f+="and ("+this.mParameters["filter"]+")";var p=[];if(s)p.push("$select="+s);if(f)p.push("$filter="+f);if(O)p.push("$orderby="+O);if(b)p.push("$skip="+b);if(t)p.push("$top="+t);if(i)p.push("$inlinecount="+i);return p};A.prototype._executeBatchRequest=function(r){var c=this.iAnalyticalInfoVersionNumber;var t=this;var b=[],e=[];for(var i=-1,R;R=r[++i];){var a=R.oAnalyticalQueryRequest,g=R.sGroupId;if(a.getURIQueryOptionValue("$select")==null){this.fireDataRequested();var E=this.getModel().getContext("/artificialRootContent");g=null;this.mLength[g]=1;this.mFinalLength[g]=true;this.mKey[g]=["artificialRootContent"];this.bNeedsUpdate=true;var t=this;if(r.length==1){setTimeout(function(){t.fireDataReceived()})}this.bArtificalRootContext=true;continue}var p=a.getURIToQueryResultEntries();if(p.indexOf("/")==0)p=p.substring(1);if(!this._isRequestPending(R.sRequestId)){this._registerNewRequest(R.sRequestId);b.push(this.oModel.createBatchOperation(p.replace(/\ /g,"%20"),"GET"));e.push(R)}}q.sap.log.debug("AnalyticalBinding: executing batch request with "+e.length+" operations");var d=this._getIdForNewRequestHandle();if(b.length>0){this.oModel.addBatchReadOperations(b);this.fireDataRequested();var f=this.oModel.submitBatch(s,h,true,true);this.oModel.fireRequestSent({url:this.oModel.sServiceUrl+"/$batch",type:"POST",async:true,info:"",infoObject:{}});this._registerNewRequestHandle(d,f)}function s(D,j){t._deregisterHandleOfCompletedRequest(d);if(e.length!=D.__batchResponses.length)q.sap.log.fatal("assertion failed: received "+D.__batchResponses.length+" responses for "+e.length+" read operations in the batch request");if(c!=t.iAnalyticalInfoVersionNumber){for(var i=-1,k;k=e[++i].sRequestId;){t._deregisterCompletedRequest(k);t._cleanupGroupingForCompletedRequest(k)}return}for(var i=0;i<D.__batchResponses.length;i++){if(D.__batchResponses[i].data!=undefined){switch(e[i].iRequestType){case A._requestType.groupMembersQuery:t._processGroupMembersQueryResponse(e[i],D.__batchResponses[i].data);break;case A._requestType.totalSizeQuery:t._processTotalSizeQueryResponse(e[i],D.__batchResponses[i].data);break;default:q.sap.log.fatal("invalid request type "+e[i].iRequestType);continue}}t._deregisterCompletedRequest(e[i].sRequestId);t._cleanupGroupingForCompletedRequest(e[i].sRequestId)}var O=true;var B=t.oModel._getBatchErrors(D);if(B.length>0)O=false;t.oModel.fireRequestCompleted({url:j.requestUri,type:"POST",async:true,info:"",infoObject:{},success:O,errorobject:O?{}:t.oModel._handleError(B[0])});if(O)t._fireChange({reason:C.Change});t.fireDataReceived()}function h(j){t._deregisterHandleOfCompletedRequest(d);for(var i=-1,k;k=e[++i];){t._deregisterCompletedRequest(k.sRequestId);t._cleanupGroupingForCompletedRequest(k.sRequestId)}if(c!=t.iAnalyticalInfoVersionNumber){return}t.oModel.fireRequestCompleted({url:"",type:"POST",async:true,info:"",infoObject:{},success:false,errorobject:t.oModel._handleError(j)});t.fireRequestFailed(t.oModel._handleError(j));t.fireDataReceived()}};A.prototype._executeQueryRequest=function(r){if(r.iRequestType==A._requestType.groupMembersAutoExpansionQuery){for(var i=-1,a;a=r.aGroupMembersAutoExpansionRequestDetails[++i];){this._executeQueryRequest(a)}return}var c=this.iAnalyticalInfoVersionNumber;var a=r.oAnalyticalQueryRequest,g=r.sGroupId;var p=a.getURIToQueryResultEntitySet();var P=this._getQueryODataRequestOptions(a);var t=this;if(a.getURIQueryOptionValue("$select")==null){this.fireDataRequested();var e=this.getModel().getContext("/artificialRootContent");g=null;this.mLength[g]=1;this.mFinalLength[g]=true;this.mKey[g]=["artificialRootContent"];this.bNeedsUpdate=true;var t=this;setTimeout(function(){if(t._cleanupGroupingForCompletedRequest(r.sRequestId))t.fireDataReceived()});this.bArtificalRootContext=true;return}this._registerNewRequest(r.sRequestId);this.fireDataRequested();for(var i=0;i<P.length;i++)P[i]=P[i].replace(/\ /g,"%20");q.sap.log.debug("AnalyticalBinding: executing query request");var R=this._getIdForNewRequestHandle();this.oModel._loadData(p,P,s,E,false,u,f);function s(d){t._deregisterHandleOfCompletedRequest(R);if(c!=t.iAnalyticalInfoVersionNumber){t._deregisterCompletedRequest(r.sRequestId);return}switch(r.iRequestType){case A._requestType.groupMembersQuery:t._processGroupMembersQueryResponse(r,d);break;case A._requestType.totalSizeQuery:t._processTotalSizeQueryResponse(r,d);break;case A._requestType.levelMembersQuery:t._processLevelMembersQueryResponse(r,d);break;default:q.sap.log.fatal("invalid request type "+r.iRequestType);break}t._deregisterCompletedRequest(r.sRequestId)}function f(){if(c!=t.iAnalyticalInfoVersionNumber){return}if(t._cleanupGroupingForCompletedRequest(r.sRequestId))t.fireDataReceived()}function E(d){t._deregisterHandleOfCompletedRequest(R);t._deregisterCompletedRequest(r.sRequestId);t._cleanupGroupingForCompletedRequest(r.sRequestId);if(c!=t.iAnalyticalInfoVersionNumber){return}t.fireDataReceived()}function u(b){t._registerNewRequestHandle(R,b)}};A.prototype._abortAllPendingRequests=function(){this._abortAllPendingRequestsByHandle();this._clearAllPendingRequests()};A.prototype._processGroupMembersQueryResponse=function(r,d){var g=r.sGroupId,s=r.aSelectedUnitPropertyName,a=r.aAggregationLevel,b=r.iStartIndex,l=r.iLength;if(!this.mKey[g])this.mKey[g]=[];var K=this.mKey[g];var c=b;var u=(s.length>0);var p=null,D=null;var f=-1;var e=0;var h=null;for(var i=0;i<d.results.length;i++){var E=d.results[i];if(u){D="";for(var j=0;j<a.length;j++){D+=E[a[j]]+"|"}if(p==D){if(f==-1)f=i-1;var m=-1,P=d.results[i-1];for(var k=0;k<s.length;k++){if(P[s[k]]!=E[s[k]]){m=k;break}}if(m==-1)q.sap.log.fatal("assertion failed: no deviating units found for result entries "+(i-1)+" and "+i)}if((p!=D||i==d.results.length-1)&&f!=-1){var M=q.extend(true,{},d.results[f]);var n=this.oModel._getObject("/"+this.oModel._getKey(d.results[f]));for(var k=0;k<s.length;k++)M[s[k]]="*";for(var t in this.oMeasureDetailsSet){var v=this.oMeasureDetailsSet[t];if(v.rawValuePropertyName!=undefined)M[v.rawValuePropertyName]="*";if(v.formattedValuePropertyName!=undefined)M[v.formattedValuePropertyName]="*"}var w="";if(h==null)h=this.oAnalyticalQueryResult.getAllDimensionNames().concat([]).sort();for(var k=0;k<h.length;k++){var x=M[h[k]];w+=(x===undefined?"":x)+","}M.__metadata.uri=w+"-multiple-units-not-dereferencable";delete M.__metadata["self"];delete M.__metadata["self_link_extensions"];M["^~volatile"]=true;this.oModel._importData(M,{});this.oModel.getContext('/'+M.__metadata.uri)["_volatile"]=true;K[c-1]=this.oModel._getKey(M);if(i==d.results.length-1&&p==D)e+=i-f;else e+=i-f-1;f=-1;if(p!=D)K[c++]=this.oModel._getKey(E)}else if(p!=D)K[c++]=this.oModel._getKey(E);p=D}else K[c++]=this.oModel._getKey(E)}if(d.__count){this.mLength[g]=parseInt(d.__count,10)-e;this.mFinalLength[g]=true;if(r.bIsFlatListRequest)this.iTotalSize=d.__count}if(this.mLength[g]<b+d.results.length){this.mLength[g]=b+(d.results.length-e);this.mFinalLength[g]=false}if((d.results.length-e)<l||l===undefined){this.mLength[g]=b+(d.results.length-e);this.mFinalLength[g]=true}if(d.results.length==0){this.mLength[g]=0;this.mFinalLength[g]=true}this.bNeedsUpdate=true};A.prototype._processTotalSizeQueryResponse=function(r,d){var a=r.oAnalyticalQueryRequest;if(d.__count==undefined){q.sap.log.fatal("missing entity count in query result");return}this.iTotalSize=d.__count};A.prototype._processLevelMembersQueryResponse=function(r,d){var a=r.oAnalyticalQueryRequest;if(d.results.length==0)return;var p=this._getGroupIdFromContext(this.oModel.getContext("/"+this.oModel._getKey(d.results[0])),r.iLevel-1);var P=[];for(var i=0;i<d.results.length;i++){var e=d.results[i];var c=this.oModel.getContext("/"+this.oModel._getKey(d.results[i]));var s=this._getGroupIdFromContext(c,r.iLevel-1);if(p==s){P.push(e);if(i<d.results.length-1)continue}var g={iRequestType:A._requestType.groupMembersQuery,sRequestId:this._getRequestId(A._requestType.groupMembersQuery,{groupId:p}),oAnalyticalQueryRequest:r.oAnalyticalQueryRequest,sGroupId:p,aSelectedUnitPropertyName:r.aSelectedUnitPropertyName,aAggregationLevel:r.aAggregationLevel,bIsFlatListRequest:false,iStartIndex:r.iStartIndex,iLength:r.iLength};var b=q.extend(true,{},d);b.results=P;this._processGroupMembersQueryResponse(g,b);if(i<d.results.length-1){p=s;P=[e]}}};A.prototype._getLoadedContextsForGroup=function(g,s,l){var c=[],a,k=this.mKey[g],K;if(!k)return c;if(!s)s=0;if(!l){l=this.oModel.iSizeLimit;if(this.mFinalLength[g]&&this.mLength[g]<l)l=this.mLength[g]}for(var i=s;i<s+l;i++){K=k[i];if(!K){break}a=this.oModel.getContext('/'+K);c.push(a)}return c};A.prototype._calculateRequiredGroupSection=function(g,s,l,t,c){var L=false,a,b,p,P,r,d={},k=this.mKey[g],K;b=s;a=0;if(!k){P=s;p=s+l}else{for(var i=s-1;i>=Math.max(s-t,0);i--){K=k[i];if(!K){P=i+1;break}}for(var j=s+l;j<s+l+t;j++){K=k[j];if(!K){p=j;break}}}r=s-P;if(P&&s>t&&r<t){if(c.length!=l)b=s-t;else b=P-t;a=t}if(b==s)b+=c.length;if(c.length!=l)a+=l-c.length;r=p-s-l;if(r==0)a+=t;if(p&&r<t&&r>0){if(b>=s){b=p;a+=t}}if(this.mFinalLength[g]&&this.mLength[g]<(a+b))a=this.mLength[g]-b;d.startIndex=b;d.length=a;return d};A.prototype._calculateRequiredGroupExpansion=function(g,l,s,L){if(l==this.iAutoExpandGroupsToLevel){var c=this._getLoadedContextsForGroup(g,s,L);var a=s+c.length-1;if(!this.mFinalLength[g]){if(c.length<L)return{groupId_Missing:g,startIndex_Missing:a+1,length_Missing:L-c.length};else return{groupId_Missing:null,length_Missing:0}}else{if(c.length<L)return{groupId_Missing:null,length_Missing:L-c.length};else return{groupId_Missing:null,length_Missing:0}}}var c=this._getLoadedContextsForGroup(g,s,L);var b=L,a=s+c.length-1;for(var i=-1,d;d=c[++i];){b--;var G=this._calculateRequiredGroupExpansion(this._getGroupIdFromContext(d,l),l+1,0,b);if(G.groupId_Missing==null){if(G.startIndex_Missing==0)return G;else b=G.length_Missing}else{return G}if(b==0)break}if(this.mFinalLength[g]||b==0)return{groupId_Missing:null,length_Missing:b};else return{groupId_Missing:g,startIndex_Missing:a+1,length_Missing:b}};A.prototype._getResourcePath=function(){return this.isRelative()?this.oModel.resolve(this.sPath,this.getContext()):this.sPath};A.prototype._getEntitySet=function(){var e=this.sEntitySetName;var b=this.getContext();if(!e){e=this.sPath.split("/")[1];if(e.indexOf("(")!=-1){e=e.split("(")[0]+"Results"}}return e};A.prototype._applyUI5SorterToSortExpression=function(s,a){if(s){for(var i in s){var p=this.mAnalyticalInfoByProperty[s[i].sPath];if(p===undefined||p==null)q.sap.log.fatal("assertion failed: sorting property "+s[i].sPath+" not found in analytical info");a.addSorter(s[i].sPath,s[i].bDescending?o.SortOrder.Descending:o.SortOrder.Ascending)}}};A.prototype._getGroupIdFromContext=function(c,l){if(!c){return null}var g="/";var d=null;if(l>this.aAggregationLevel.length)q.sap.log.fatal("assertion failed: aggregation level deeper than number of current aggregation levels");for(var i=0;i<l;i++){d=c.getProperty(this.aAggregationLevel[i]);if(d!=null){g+=encodeURIComponent(d)+"/"}else{g+="@/"}}return g};A.prototype._getGroupIdLevel=function(g){if(g==null){q.sap.log.fatal("assertion failed: no need to determine level of group ID = null");return-1}return g.split("/").length-2};A.prototype._getGroupIdComponents=function(g){if(g==null)return null;var G=g.split("/");var d=new Array();for(var i=1;i<G.length-1;i++){if(G[i]=="@")d[i-1]=null;else d[i-1]=decodeURIComponent(G[i])}return d};A.prototype._getGroupIdAncestors=function(g,n){if(!n)return[];if(g==null){q.sap.log.fatal("group ID null does not have ancestors");return[]}if(g=="/")if(Math.abs(n)==1)return[null];else{q.sap.log.fatal("invalid level count "+n+" for ancestors of groupId "+g);return[]}var G=g.split("/");var a=new Array(),s="";var f=0,t=G.length-3;if(n>0)if(n-1>t)q.sap.log.fatal("invalid level count "+n+" for ancestors of groupId "+g);else t=n-1;else if(-(n+1)>t)q.sap.log.fatal("invalid level count "+n+" for ancestors of groupId "+g);else{f=t+1+n;for(var i=0;i<f;i++){s+=G[i]+"/"}}for(var i=f;i<=t;i++){s+=G[i]+"/";a.push(s)}return a};A.prototype._getParentGroupId=function(g){return this._getGroupIdAncestors(g,-1)[0]};A.prototype._removeDuplicatesFromStringArray=function(a){var t={};for(var i=0;i<a.length;i++)t[a[i]]=true;var u=[];for(var s in t)u.push(s);return u};A.prototype._getIdForNewRequestHandle=function(){if(this.oPendingRequestHandle===undefined)this.oPendingRequestHandle=[];for(var i=0;i<this.oPendingRequestHandle.length;i++){if(this.oPendingRequestHandle[i]===undefined)return i}this.oPendingRequestHandle[this.oPendingRequestHandle.length]=undefined;return this.oPendingRequestHandle.length-1};A.prototype._registerNewRequestHandle=function(r,R){if(this.oPendingRequestHandle[r]!==undefined)q.sap.log.fatal("request handle ID already in use");this.oPendingRequestHandle[r]=R};A.prototype._deregisterHandleOfCompletedRequest=function(r){if(this.oPendingRequestHandle[r]===undefined)q.sap.log.fatal("no handle found for this request ID");this.oPendingRequestHandle[r]=undefined};A.prototype._abortAllPendingRequestsByHandle=function(){for(var i=0;i<this.oPendingRequestHandle.length;i++){this.oPendingRequestHandle[i]!==undefined&&this.oPendingRequestHandle[i].abort()}this.oPendingRequestHandle=[]};A.prototype._getRequestId=function(r,p){switch(r){case A._requestType.groupMembersQuery:if(p.groupId===undefined)q.sap.log.fatal("missing group ID");var g=p.groupId;return A._requestType.groupMembersQuery+(g==null?"":g);case A._requestType.levelMembersQuery:if(p.level===undefined)q.sap.log.fatal("missing level");var l=p.level;return""+A._requestType.levelMembersQuery+l;case A._requestType.totalSizeQuery:return A._requestType.totalSizeQuery;default:q.sap.log.fatal("invalid request type "+r);return-1}};A.prototype._registerNewRequest=function(r){if(r==undefined||r==""){q.sap.log.fatal("missing request ID");return}if(!this.oPendingRequests[r])this.oPendingRequests[r]=1;else++this.oPendingRequests[r]};A.prototype._considerRequestGrouping=function(r){for(var i=-1,R;R=r[++i];){if(this.oGroupedRequests[R]===undefined)this.oGroupedRequests[R]={};var g=this.oGroupedRequests[R];for(var j=0;j<r.length;j++)g[r[j]]=true}};A.prototype._isRequestPending=function(r){return this.oPendingRequests[r]!=undefined&&this.oPendingRequests[r]>0};A.prototype._deregisterCompletedRequest=function(r){if(!this.oPendingRequests[r])q.sap.log.fatal("assertion failed: there is no pending request ID "+r);if(this.oPendingRequests[r]==1)delete this.oPendingRequests[r];else--this.oPendingRequests[r]};A.prototype._cleanupGroupingForCompletedRequest=function(r){if(this._isRequestPending(r))return false;var g=true;if(this.oGroupedRequests[r]!=undefined){for(var O in this.oGroupedRequests[r]){if(this.oPendingRequests[O]){g=false;break}}}if(g){var R=this.oGroupedRequests[r];delete this.oGroupedRequests[r];for(var O in R){if(O!=r)this._cleanupGroupingForCompletedRequest(O)}}return g};A.prototype._clearAllPendingRequests=function(){this.oPendingRequests={};this.oGroupedRequests={}};A.prototype.resetData=function(c){if(c){var p=c.getPath();delete this.mKey[p];delete this.mLength[p];delete this.mFinalLength[p]}else{this.mKey={};this.mLength={};this.mFinalLength={}}};A.prototype.refresh=function(f,c,e){var b=false;if(!f){if(e){var r=this.oModel.resolve(this.sPath,this.oContext);var E=this.oModel.oMetadata._getEntityTypeByPath(r);if(E&&(E.entityType in e))b=true}if(c&&!b){q.each(this.mKey,function(i,n){q.each(n,function(i,k){if(k in c){b=true;return false}});if(b)return false})}if(!c&&!e){b=true}}if(f||b){this._abortAllPendingRequests();this.resetData();this.bNeedsUpdate=false;this._fireRefresh({reason:sap.ui.model.ChangeReason.Refresh})}};A.prototype.checkUpdate=function(f,c){var b=false;if(!f){if(this.bNeedsUpdate||!c){b=true}else{q.each(this.mKey,function(i,n){q.each(n,function(i,k){if(k in c){b=true;return false}});if(b)return false})}}if(f||b){this.bNeedsUpdate=false;this._fireChange()}};return A},true);
